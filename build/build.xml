<?xml version="1.0"?>
<project name="Workbench" default="dist" basedir="..">
	<property name="dir.src" value="workbench"/>
	<property name="dir.src.bulkclient" value="${dir.src}/bulkclient"/>
	<property name="dir.test" value="workbench-test"/>
	<property name="dir.build" value="build"/>
	<property name="dir.build.lib" value="${dir.build}/lib"/>
	<property name="dir.dist" value="dist"/>
		
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
  		<classpath>
    		<pathelement location="${dir.build.lib}/ant-contrib-1.0b3.jar"/>
	    </classpath>
	</taskdef>
	
	<target name="init">		
		<loadfile srcfile="${dir.src}/config.php" property="app.config"/>

        <propertyregex property="app.version"
              input="${app.config}"
              regexp="\$GLOBALS\[&quot;WORKBENCH_VERSION&quot;\] = &quot;(.+)&quot;;"
              select="\1"
              casesensitive="false" />
                      
        <echo message="App Version: ${app.version}"/>
                      
        <propertyregex property="app.version.stripped"
              input="${app.version}"
              regexp="\s"
              replace="_"
              global="true"
              defaultValue="${app.version}"/>
                            
        <echo message="App Version Stripped: ${app.version.stripped}"/>
                      
        <condition property="app.beta">
	    	<contains string="${app.version}" substring="Beta"/>
		</condition>		
	</target>
	
	<target name="clean">
		<delete dir="${dir.dist}"/>
	</target>
	
	<target name="dist" depends="init, clean">
		<mkdir dir="${dir.dist}"/>
                      
        <property name="dist.zip.workbench" value="${dir.dist}/workbench-${app.version.stripped}.zip"/>
        
		<zip destfile="${dist.zip.workbench}" basedir="${dir.src}" excludes="**/*Mock*"/>
				
		<condition 
		        property="dist.txt.latestVersionAvailble" 
		        value="${dir.dist}/latestVersionAvailableBeta.txt" 
		        else="${dir.dist}/latestVersionAvailable.txt">
			<istrue value="${app.beta}"/>
		</condition>
		
		<concat destfile="${dist.txt.latestVersionAvailble}">${app.version}</concat>

		<property name="dist.zip.bulkclient" value="${dir.dist}/PHP_BulkApiClient-${app.version.stripped}.zip"/>

		<zip destfile="${dist.zip.bulkclient}" basedir="${dir.src.bulkclient}"/>
	</target>
	
	<target name="upload" depends="dist">
		<taskdef classname="net.bluecow.googlecode.ant.GoogleCodeUploadTask" classpath="${dir.build.lib}/ant-googlecode-0.0.2.jar" name="gcupload"/>
		
		<condition 
		        property="gc.labels" 
		        value="Beta" 
		        else="">
			<istrue value="${app.beta}"/>
		</condition>
		
		<gcupload 
				username="${gc.username}" 
				password="${gc.password}" 
				projectname="forceworkbench" 
				filename="${basedir}/${dist.zip.workbench}" 
				targetfilename="${dist.zip.workbench}"
				summary="Workbench ${app.version}"
				labels="${gc.labels}, Featured" />
				
		<gcupload 
				username="${gc.username}" 
				password="${gc.password}" 
				projectname="forceworkbench" 
				filename="${basedir}/${dist.zip.bulkclient}" 
				targetfilename="${dist.zip.bulkclient}"
				summary="PHP Bulk API Client ${app.version}"
				labels="${gc.labels}" />	
	</target>
	
	<target name="update" depends="dist">		
		<scp sftp="false" file="${dist.txt.latestVersionAvailble}" todir="${sf.username},forceworkbench:${sf.password}@web.sourceforge.net:/home/groups/f/fo/forceworkbench/htdocs/"/>
	</target>

	<target name="deploy" depends="upload, update"/>
</project>